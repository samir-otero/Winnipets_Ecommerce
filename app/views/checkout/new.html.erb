<div class="container mt-4">
  <div class="row">
    <div class="col-lg-8">
      <h1>Checkout</h1>

      <%= form_with url: checkout_path, method: :post, local: true do |f| %>
        <div class="card mb-4">
          <div class="card-header">
            <h4>Contact Information</h4>
          </div>
          <div class="card-body">
            <% if @guest_user.errors.any? %>
              <div class="alert alert-danger">
                <h6>Please correct the following errors:</h6>
                <ul class="mb-0">
                  <% @guest_user.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>

            <%= f.fields_for :guest_user, @guest_user do |user_form| %>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <%= user_form.label :first_name, class: "form-label" %>
                  <%= user_form.text_field :first_name, class: "form-control #{'is-invalid' if @guest_user.errors[:first_name].any?}" %>
                  <% if @guest_user.errors[:first_name].any? %>
                    <div class="invalid-feedback">
                      <%= @guest_user.errors[:first_name].first %>
                    </div>
                  <% end %>
                </div>
                <div class="col-md-6 mb-3">
                  <%= user_form.label :last_name, class: "form-label" %>
                  <%= user_form.text_field :last_name, class: "form-control #{'is-invalid' if @guest_user.errors[:last_name].any?}" %>
                  <% if @guest_user.errors[:last_name].any? %>
                    <div class="invalid-feedback">
                      <%= @guest_user.errors[:last_name].first %>
                    </div>
                  <% end %>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <%= user_form.label :email, class: "form-label" %>
                  <%= user_form.email_field :email, class: "form-control #{'is-invalid' if @guest_user.errors[:email].any?}" %>
                  <% if @guest_user.errors[:email].any? %>
                    <div class="invalid-feedback">
                      <%= @guest_user.errors[:email].first %>
                    </div>
                  <% end %>
                </div>
                <div class="col-md-6 mb-3">
                  <%= user_form.label :phone, class: "form-label" %>
                  <%= user_form.telephone_field :phone, class: "form-control #{'is-invalid' if @guest_user.errors[:phone].any?}" %>
                  <% if @guest_user.errors[:phone].any? %>
                    <div class="invalid-feedback">
                      <%= @guest_user.errors[:phone].first %>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-header">
            <h4>Shipping Address</h4>
          </div>
          <div class="card-body">
            <% if @address.errors.any? %>
              <div class="alert alert-danger">
                <h6>Please correct the following errors:</h6>
                <ul class="mb-0">
                  <% @address.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>

            <%= f.fields_for :address, @address do |address_form| %>
              <div class="mb-3">
                <%= address_form.label :address_line_1, "Address", class: "form-label" %>
                <%= address_form.text_field :address_line_1, class: "form-control #{'is-invalid' if @address.errors[:address_line_1].any?}" %>
                <% if @address.errors[:address_line_1].any? %>
                  <div class="invalid-feedback">
                    <%= @address.errors[:address_line_1].first %>
                  </div>
                <% end %>
              </div>

              <div class="mb-3">
                <%= address_form.label :address_line_2, "Apartment, suite, etc. (optional)", class: "form-label" %>
                <%= address_form.text_field :address_line_2, class: "form-control" %>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <%= address_form.label :city, class: "form-label" %>
                  <%= address_form.text_field :city, class: "form-control #{'is-invalid' if @address.errors[:city].any?}" %>
                  <% if @address.errors[:city].any? %>
                    <div class="invalid-feedback">
                      <%= @address.errors[:city].first %>
                    </div>
                  <% end %>
                </div>
                <div class="col-md-3 mb-3">
                  <%= address_form.label :province_id, "Province", class: "form-label" %>
                  <%= address_form.select :province_id,
                      options_from_collection_for_select(@provinces, :id, :name, @address.province_id),
                      { prompt: "Select Province" },
                      { class: "form-select #{'is-invalid' if @address.errors[:province_id].any?}", id: "province_select" } %>
                  <% if @address.errors[:province_id].any? %>
                    <div class="invalid-feedback">
                      <%= @address.errors[:province_id].first %>
                    </div>
                  <% end %>
                </div>
                <div class="col-md-3 mb-3">
                  <%= address_form.label :postal_code, class: "form-label" %>
                  <%= address_form.text_field :postal_code, class: "form-control #{'is-invalid' if @address.errors[:postal_code].any?}", placeholder: "A1A 1A1" %>
                  <% if @address.errors[:postal_code].any? %>
                    <div class="invalid-feedback">
                      <%= @address.errors[:postal_code].first %>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <div class="d-flex justify-content-between">
          <%= link_to "Back to Cart", cart_path, class: "btn btn-outline-secondary" %>
          <%= f.submit "Place Order", class: "btn btn-success btn-lg" %>
        </div>
      <% end %>
    </div>

    <div class="col-lg-4">
      <div class="card">
        <div class="card-header">
          <h4>Order Summary</h4>
        </div>
        <div class="card-body">
          <% @cart_items.each do |item| %>
            <div class="d-flex justify-content-between mb-2">
              <span><%= item.name %> Ã— <%= item.quantity %></span>
              <span><%= number_to_currency(item.total_price) %></span>
            </div>
          <% end %>

          <hr>

          <div class="d-flex justify-content-between mb-2">
            <span>Subtotal:</span>
            <span id="order-subtotal"><%= number_to_currency(@subtotal) %></span>
          </div>

          <div class="d-flex justify-content-between mb-2" id="tax-breakdown" style="display: none;">
            <div class="w-100">
              <div class="d-flex justify-content-between" id="gst-row">
                <span>GST:</span>
                <span id="gst-amount">$0.00</span>
              </div>
              <div class="d-flex justify-content-between" id="pst-row">
                <span>PST:</span>
                <span id="pst-amount">$0.00</span>
              </div>
              <div class="d-flex justify-content-between" id="hst-row">
                <span>HST:</span>
                <span id="hst-amount">$0.00</span>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-between mb-2">
            <span>Shipping:</span>
            <span>Free</span>
          </div>

          <hr>

          <div class="d-flex justify-content-between h5">
            <strong>Total:</strong>
            <strong id="order-total"><%= number_to_currency(@subtotal) %></strong>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const provinceSelect = document.getElementById('province_select');
  const subtotal = <%= @subtotal %>;

  const taxRates = {
    <% @provinces.each do |province| %>
      '<%= province.id %>': {
        name: '<%= province.name %>',
        gst: <%= province.gst_rate %>,
        pst: <%= province.pst_rate %>,
        hst: <%= province.hst_rate %>
      },
    <% end %>
  };

  function updateTaxCalculation() {
    const selectedProvinceId = provinceSelect.value;
    const taxBreakdown = document.getElementById('tax-breakdown');
    const orderTotal = document.getElementById('order-total');

    if (selectedProvinceId && taxRates[selectedProvinceId]) {
      const rates = taxRates[selectedProvinceId];

      const gstAmount = subtotal * rates.gst;
      const pstAmount = subtotal * rates.pst;
      const hstAmount = subtotal * rates.hst;
      const totalTax = gstAmount + pstAmount + hstAmount;
      const total = subtotal + totalTax;

      // Show tax breakdown
      taxBreakdown.style.display = 'block';

      // Update individual tax amounts
      document.getElementById('gst-amount').textContent = ' + gstAmount.toFixed(2);
      document.getElementById('pst-amount').textContent = ' + pstAmount.toFixed(2);
      document.getElementById('hst-amount').textContent = ' + hstAmount.toFixed(2);

      // Hide rows for taxes that are 0
      document.getElementById('gst-row').style.display = rates.gst > 0 ? 'flex' : 'none';
      document.getElementById('pst-row').style.display = rates.pst > 0 ? 'flex' : 'none';
      document.getElementById('hst-row').style.display = rates.hst > 0 ? 'flex' : 'none';

      // Update total
      orderTotal.textContent = ' + total.toFixed(2);
    } else {
      taxBreakdown.style.display = 'none';
      orderTotal.textContent = ' + subtotal.toFixed(2);
    }
  }

  provinceSelect.addEventListener('change', updateTaxCalculation);

  // Calculate taxes on page load if province is already selected
  updateTaxCalculation();
});
</script>